#include "../include/driver.h"
#include "../include/font.h"

// ascii characters -> 5 bytes / character  = 40-pixel resolution
// Credit to chrmoe for the bitmapping work
const uchar font[455] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x5f,0x5f,0x00,0x00,	//  !
    0x00,0x03,0x00,0x03,0x00,0x14,0x7f,0x14,0x7f,0x14,	// "#
    0x24,0x2a,0x7f,0x2a,0x12,0x23,0x13,0x08,0x64,0x62,	// $%
    0x36,0x49,0x55,0x22,0x50,0x00,0x05,0x03,0x00,0x00,	// &'
    0x00,0x1c,0x22,0x41,0x00,0x00,0x41,0x22,0x1c,0x00,	// ()
    0x14,0x08,0x3e,0x08,0x14,0x08,0x08,0x3e,0x08,0x08,	// *+
    0x00,0x50,0x30,0x00,0x00,0x08,0x08,0x08,0x08,0x08,	// ,-
    0x00,0x60,0x60,0x00,0x00,0x20,0x10,0x08,0x04,0x02,	// ./
    0x3e,0x51,0x49,0x45,0x3e,0x00,0x42,0x7f,0x40,0x00,	// 01
    0x42,0x61,0x51,0x49,0x46,0x21,0x41,0x45,0x4b,0x31,	// 23
    0x18,0x14,0x12,0x7f,0x10,0x27,0x45,0x45,0x45,0x39,	// 45
    0x3c,0x4a,0x49,0x49,0x30,0x01,0x71,0x09,0x05,0x03,	// 67
    0x36,0x49,0x49,0x49,0x36,0x06,0x49,0x49,0x29,0x1e,	// 89
    0x00,0x36,0x36,0x00,0x00,0x00,0x56,0x36,0x00,0x00,	// :;
    0x08,0x14,0x22,0x41,0x00,0x14,0x14,0x14,0x14,0x14,	// <=
    0x00,0x41,0x22,0x14,0x08,0x02,0x01,0x51,0x09,0x06,	// >?
    0x32,0x49,0x79,0x41,0x3e,0x7e,0x11,0x11,0x11,0x7e,	// @A
    0x7f,0x49,0x49,0x49,0x36,0x3e,0x41,0x41,0x41,0x22,	// BC
    0x7f,0x41,0x41,0x22,0x1c,0x7f,0x49,0x49,0x49,0x41,	// DE
    0x7f,0x09,0x09,0x09,0x01,0x3e,0x41,0x49,0x49,0x7a,	// FG
    0x7f,0x08,0x08,0x08,0x7f,0x00,0x41,0x7f,0x41,0x00,	// HI
    0x20,0x40,0x41,0x3f,0x01,0x7f,0x08,0x14,0x22,0x41,	// JK
    0x7f,0x40,0x40,0x40,0x40,0x7f,0x02,0x0c,0x02,0x7f,	// LM
    0x7f,0x04,0x08,0x10,0x7f,0x3e,0x41,0x41,0x41,0x3e,	// NO
    0x7f,0x09,0x09,0x09,0x06,0x3e,0x41,0x51,0x21,0x5e,	// PQ
    0x7f,0x09,0x19,0x29,0x46,0x46,0x49,0x49,0x49,0x31,	// RS
    0x01,0x01,0x7f,0x01,0x01,0x3f,0x40,0x40,0x40,0x3f,	// TU
    0x1f,0x20,0x40,0x20,0x1f,0x3f,0x40,0x38,0x40,0x3f,	// VW
    0x63,0x14,0x08,0x14,0x63,0x07,0x08,0x70,0x08,0x07,	// XY
    0x61,0x51,0x49,0x45,0x43,0x00,0x7f,0x41,0x41,0x00,	// Z[
    0x02,0x04,0x08,0x10,0x20,0x00,0x41,0x41,0x7f,0x00,	// \]
    0x04,0x02,0x01,0x02,0x04,0x40,0x40,0x40,0x40,0x40,	// ^_
    0x00,0x01,0x02,0x04,0x00,0x20,0x54,0x54,0x54,0x78,	// `a
    0x7f,0x48,0x44,0x44,0x38,0x38,0x44,0x44,0x44,0x20,	// bc
    0x38,0x44,0x44,0x48,0x7f,0x38,0x54,0x54,0x54,0x18,	// de
    0x08,0x7e,0x09,0x01,0x02,0x0c,0x52,0x52,0x52,0x3e,	// fg
    0x7f,0x08,0x04,0x04,0x78,0x00,0x44,0x7d,0x40,0x00,	// hi
    0x20,0x40,0x44,0x3d,0x00,0x7f,0x10,0x28,0x44,0x00,	// jk
    0x00,0x41,0x7f,0x40,0x00,0x7c,0x04,0x18,0x04,0x78,	// lm
    0x7c,0x08,0x04,0x04,0x78,0x38,0x44,0x44,0x44,0x38,	// no
    0x7c,0x14,0x14,0x14,0x08,0x08,0x14,0x14,0x18,0x7c,	// pq
    0x7c,0x08,0x04,0x04,0x08,0x48,0x54,0x54,0x54,0x20,	// rs
    0x04,0x3f,0x44,0x40,0x20,0x3c,0x40,0x40,0x20,0x7c,	// tu
    0x1c,0x20,0x40,0x20,0x1c,0x3c,0x40,0x30,0x40,0x3c,	// vw
    0x44,0x28,0x10,0x28,0x44,0x0c,0x50,0x50,0x50,0x3c,	// xy
    0x44,0x64,0x54,0x4c,0x44				// z
};

// misc bitmap symbols
const uchar bitmaps[8][8] = {
    {0xc3,0xc3,0x00,0x18,0x18,0x81,0xff,0x7e}, // smiley 3 small
    {0x3c,0x42,0x81,0x81,0xc3,0x24,0xa5,0xe7}, // Omega
    {0x00,0x04,0x06,0xff,0xff,0x06,0x04,0x00}, // Arrow
    {0x81,0x42,0x24,0x18,0x18,0x24,0x42,0x81}, // X
    {0xBD,0xA1,0xA1,0xB9,0xA1,0xA1,0xA1,0x00}, // ifi
    {0xEF,0x48,0x4B,0x49,0x4F,0x00,0x00,0x00},
    {0x00,0x24,0x24,0x00,0x42,0x42,0x3C,0x00}, // SMILEY 2
    {0x10,0x38,0x54,0x38,0x10,0x10,0x28,0x44}  // stick figure with arms outstretched
};

const uchar paths[44] = {
    0x07,0x06,0x05,0x04,0x03,0x02,0x01,0x00,
    0x10,0x20,0x30,0x40,0x50,0x60,0x70,0x71,
    0x72,0x73,0x74,0x75,0x76,0x77,0x67,0x57,
    0x47,0x37,0x27,0x17,0x04,0x03,0x12,0x21,
    0x30,0x40,0x51,0x62,0x73,0x74,0x65,0x56,
    0x47,0x37,0x26,0x15
}; // circle, len 16, offset 28

/*
===================
 Name

 Desc
===================
*/
void F_SendText(const char *str, rgb_t color) {
    uint16 x, z, i;
    static uint16 shifts;
    unsigned char chr[5];   // stores the current character

        //	While we haven't hit the null byte...
        while (*str) {
            // Get the current character in the pointer and move it into 'chr'
            F_Getchar(*str++, chr);
            // Put a character on 'front' of cube.
            for (x = 0; x < 5; x++) {
                for (z = 0; z < 8; z++)	{
                    if (chr[x] & (0x80 >> z)) {
                        // x is offset by a small amount to center because each character
                        // is only 5 pixels wide
                        V_Set(x+2, 0, z, color);
                    }
                }
            }
            // Draw the character on the cube face
            D_FBUpdate();
            for (i = 0; i < 5; i++) {
                if ( TSTFLAG ( xsig.AFLAGS, ANIM_CHANGE_PENDING ) ) {
                    return;
                }
                // block and delay for a moment
                while ( !D_Delayms( (float)1/ptrAnim->rate * 30000.f ) ) {}
                D_Shift('Y', SHIFT_OUT);
                D_FBUpdate();
            }
        }   // end while

    // make sure last character is shifted out of the cube once
    // we break out of the while loop
    for (i = 0; i < 8; i++) {
        if ( TSTFLAG ( xsig.AFLAGS, ANIM_CHANGE_PENDING ) ) {
                    return;
                }
      // block and delay for a moment
        while ( !D_Delayms( (float)1/ptrAnim->rate * 30000.f ) ) {}
        D_Shift('Y', SHIFT_OUT);
        D_FBUpdate();
    }
}

/*
===================
 Name

 Desc
===================
*/
void F_GetPath(uchar path, uchar *destination, int length) {
	int i;
	int offset = 0;

	if (path == 1)
		offset = 28;

	for (i = 0; i < length; i++) {
		destination[i] = paths[i+offset];
	}
}

/*
===================
 Name

 Desc
===================
*/
void F_Getchar (char chr, uchar *dst) {
    uint8 i;
    // our bitmap font starts at ascii char 32 (decimal, space char). This ensures the input
    // ascii character is aligned with the start of the bitmap.
    chr -= 32;

    // loop through each byte of the array and store slice in dst[i] until entire char is built
    for (i = 0; i < 5; i++) {
		dst[i] = font[(chr*5)+i];
    }
}

/*
===================
 Name

 Desc
===================
*/
void F_GetBitmap (char bitmap, uchar *dst) {
    uint8 i;

    // Loads bitmap into destination array
    for (i = 0; i < 8; i++) {
        dst[i] = bitmaps[(uint8)bitmap][(uint8)i];
    }

}

/*
===================
 Name

 Desc
===================
*/
uint8 F_GetBitmapPixel (char bitmap, char x, char y) {
    uint8 tmp = bitmaps[(uint8)bitmap][(uint8)x];
    return (tmp >> y) & 0x01;
}
